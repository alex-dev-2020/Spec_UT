

#### Раздел 2. Задания на изменение функциональности

##### Задача №2.1

###### Постановка

Отчет "Ведомость по товарам в ценах номенклатуры" предоставляет стоимостную 
оценку остатков, оборотов в ценах по выбранному виду цен. 

Стоимостная оценка производится в валюте выбранного вида цен. 

Руководству компании (по своим соображениям) необходимо получать эту оценку в произвольной валюте. 

Вид цены и валюта должны выбираться в форме отчета. 

Необходимо реализовать данную возможность (изменив отчет, предоставляемый поставщиком конфигурации). 

Также требуется, чтобы после выбора типа цены в реквизит "Валюта", расположенный в диалоге отчета, по умолчанию подставлялась валюта, указанная для выбранного типа цен.



######  Реализация

Демо-база после Задача № 1.3


- Выгружаем отчет:  Отчет `ВедомостьПоТоварамНаСкладахВЦенахНоменклатуры` как внешний
- Переименовываем: `ВедомостьПоТоварамНаСкладахВЦенахНоменклатуры_ВыборВалюты`
    - Использование в коде объекта метаданных
        - [`получение Макета`]()
- Переименовываем Синоним → "Ведомость по товарам в ценах номенклатуры с выбором валюты"
- Проверям, что Отчет в принципе формируется (Приложение)
- Параметры настроек отчета
    - Оценка Запасов
        - По учетному виду цен склада
        - По розничному виду цен склада
        - По виду цен, указанному в отчете ← **Вид Цены будет УКАЗАН в отчете** 
    - при  выборе  варианта :"По учетному виду цен склада"
        - Отчет с оценкой формируется ТОЛЬКО для  Розничного Склада
        - → меняем (указываем) в  настройках Оптового  Склада  учетный Вид Цены
    - → Отчет формируется

- СКД
    - Запрос СКД 
    - Находим  ВТ `ИзмененияЦен`  
        - Значения из этой таблицы необходимо умножить на Кросс-Курс 
            -*(пересчет из Валюты учетной Цены Склада в Валюту Настроек Отчета)*
    - Добаляем в пакет Запросов Новый 
        - Таблица: `КурсыВалютСрезПоследних` переименовываем → `КурсыВалют_ВалютаВидаЦены`  
        - Параметры Вирт Таблицы:
            - необходим Отбор по Валюте (берем из Спр. `ВидыЦен` - вложенный запрос)
                - *(будет указана в Виде Цены )* 
        - Таблица: `КурсыВалютСрезПоследних` переименовываем → `КурсыВалют_ВалютаОтчета`  
            - необходим Отбор по Валюте ` Валюта = &Валюта` (*(будет указана в настройках Отчета)* )
        - Поле Запроса →  коэффициент Пересчета (Кросс-Курс)
            - Добавлячем  вычисляемое Поле:


            ``` 

            (ЕСТЬNULL(КурсыВалют_ВалютаВидаЦены.Курс, 1) / ЕСТЬNULL(КурсыВалют_ВалютаВидаЦены.Кратность, 1)) / (ЕСТЬNULL(КурсыВалют_ВалютаОтчета.Курс, 1)/ЕСТЬNULL(КурсыВалют_ВалютаОтчета.Кратность, 1))

            ```

        - Закладка "Связи":
            - Полное Соединение :  `КурсыВалют_ВалютаВидаЦены` → `КурсыВалют_ВалютаОтчета`  ИСТИНА 
        - Закладка "Дополнительно":
            - ВТ `ВТ_КроссКурс`
        - Закладка "Объедининия/Псведонимы": 
            - Поле : "`КроссКурс`" 
        - Закладка "Компоновка Данных":
            -  Параметры Вирт Таблиц :  `&КонецПериода` *(для обоих `КурсыВалют_ВалютаВидаЦены` / `КурсыВалют_ВалютаОтчета` )*
        - Закладка "Пакет Запросов":
            - Поднимаем над ВТ `ИзмененияЦен` 
    - Таблица `ИзмененияЦен` 

        - 

   - Таблица `БлижайшиеОстаткиПоНоменклатуре`
    - Добаваляем `ВТ_КроссКурс`
        - вычисялемые Значения:
            - Цена
            - СтараяЦена
            - Дельта
        - умножаем на `* ВТ_КроссКурс.КроссКурс`
- СКД 
    - Закладка "Параметры"
        - Смотрим как называется Параметр Отчета  ВидЦены
        - в запросе для ВТ `КросКурс`  параметр `&Ссылка`  меняем на `&ВидЦены`
    


         ``` 

    Валюта В
		(ВЫБРАТЬ
			ВидыЦен.ВалютаЦены КАК ВалютаЦены
		ИЗ
			Справочник.ВидыЦен КАК ВидыЦен
		ГДЕ
			ВидыЦен.Ссылка = &ВидЦены)

         ``` 
    - Новый Парметр `Валюта`
        - снимаем Ограничени доступности
        - используем ВСЕГДА 
        - Закладка СКД  "Настройки"
            - Добавляем в пользовательские Обычные (НЕ быстрые) Настройки
            - для КАЖДОГО Варианта:
                - `ВедомостьВЦенахНоменклатуры`
                - `ОценкаОстатковТоваров` 
- Выбор на форме различных ВАРИАНТОВ  Оценки Запасов по виду цен
    - Параметр: `ОценкаЗапасовПоВидуЦен`
        - Доступен Список Значений
            - Дорабатываем ТОЛЬКО  вариант по п. 3  "По виду цен, указанному в отчете" 
- Устанавливаем Запрет формирования Отчета, если Валюта НЕ указана
    - [Модуль Объекта](https://github.com/alex-dev-2020/Spec_UT/commit/180928415fc870cd7c8756eb4f309099d730c00c)
- Убираем вывод Валюты в Параметрах Отчета
    -  Процедура `КомпоновкаДанныхСервер.СкрытьВспомогательныеПараметрыОтчета`
      - Параметр процедуры `ВспомогательныеПараметрыОтчета()`
    - Функция `ВспомогательныеПараметрыОтчета()` 
      -  `ВспомогательныеПараметры.Добавить("Валюта");`
- Убираем вывод Валюты в качестве Группировки
     - Выходной  Запрос: Самое первое поле `Валюта`
     - Дорабатываем:  

  ``` 
	ВЫБОР
		КОГДА &ОценкаЗапасовПоВидуЦен = 3
			ТОГДА &Валюта
		ИНАЧЕ ВидыЦен.ВалютаЦены
	КОНЕЦ КАК Валюта,

  ``` 
- Доработка Выбора валюты при Выборе Вида Цены
    - Необходимо Создать:
        - Форму Отчета
        - Форму Настроек 
    - Копируем из общих Форм
        - Переопредеялем на Скопированные
- Доработка Форм
    - ФормаНастроекОтчета
        - [`Модуль Формы` ](https://github.com/alex-dev-2020/Spec_UT/commit/7c10dc8d7fac79834f632b689a68d17412f4af14)