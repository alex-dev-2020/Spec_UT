

#### Раздел 2. Задания на изменение функциональности

##### Задача №2.6 

(Сборник УТ.5 )

###### Постановка

- В организации привыкли в течение открытого периода работать с видом цен «Нижнийпорог рентабельности». 

- Данный вид цены определяется как цены закупки с наценкой в 3 %. 
    - По пожеланию руководства необходимо расширить функциональность документа «Заказ клиента». 
    - Менеджеры по продажам должны видеть дополнительную колонку – «Нижний порог рентабельности». 
        - Части из этих менеджеров запрещено продавать товар ниже установленной цены (указывается через полномочия пользователей). 
    - Значение нижнего порога рентабельности должно
        - сохраняться в документе и 
        - проставляться
            - как при построчном заполнении табличной части, 
            - так и при использовании подбора, 
        - и должно меняться при изменении реквизитов табличной части, участвующих в ценообразовании. 

- Необходимо реализовать требования заказчика, доработки должны быть выполнены в расширении конфигурации.

###### Реализация



- Расширение
- [Модуль Формы Док. "Заказ Клиента"](https://github.com/alex-dev-2020/Spec_UT/commit/b270de551c6a02cf207e3691e03e43214ab081e4)
    - Событие ТЧ "Товары"  Поля "Номенклатура"
        - `ПриИзменениИПосле`  
        - вызываем Серверную Функцию `РассчитатьНижнийПорогРентабельностиДляСтрокиТЧТовары`
            - Аргументы (Поля Текущей Строки ТЧ "Товары")
                - Номенклатура;
                - Характеристика
- Создаем Серверную Процедуру [`РассчитатьНижнийПорогРентабельностиДляТЧТовары`](https://github.com/alex-dev-2020/Spec_UT/commit/fac5dc898a67a39240ed925baa033c735daac60b) 
    -  ТЧ Параетром  отдаем в Запрос
    - Соединиемся  с вирт.  Табл `ЦеныНоменклатуры` Срез Последних 
        - ВНУТРЕНЕЕ Соединение, Поля :
            - Номенклатура
            - Характеристика 
    - в Цикле Обходим выборку Рез-та Запроса
    - Метод "Найти строки" (Для ТЧ Товары)
        - Структура Отбора:
            - где ищем: ТЧ Товары, (колонка): "Номер Строки"
            - что ищем: Номер строки из Выборки (Рез-т Запроса)
        - в найденную Строку ТЧ (первый Эл-т результата Поиска) в колонку "Нижний порог рентабельности" пишем Цену из Выборки (Рез-т Запроса) 