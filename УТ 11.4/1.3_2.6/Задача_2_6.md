

#### Раздел 2. Задания на изменение функциональности

##### Задача №2.6 

(Сборник УТ.5 )

###### Постановка

- В организации привыкли в течение открытого периода работать с видом цен «Нижнийпорог рентабельности». 

- Данный вид цены определяется как цены закупки с наценкой в 3 %. 
    - По пожеланию руководства необходимо расширить функциональность документа «Заказ клиента». 
    - Менеджеры по продажам должны видеть дополнительную колонку – «Нижний порог рентабельности». 
        - Части из этих менеджеров запрещено продавать товар ниже установленной цены (указывается через полномочия пользователей). 
    - Значение нижнего порога рентабельности должно
        - сохраняться в документе и 
        - проставляться
            - как при построчном заполнении табличной части, 
            - так и при использовании подбора, 
        - и должно меняться при изменении реквизитов табличной части, участвующих в ценообразовании. 

- Необходимо реализовать требования заказчика, доработки должны быть выполнены в расширении конфигурации.

###### Реализация

- Реализация пересчета Значения "Нижний порог рентабельности""
    - Расширение
    - [Модуль Формы Док. "Заказ Клиента"](https://github.com/alex-dev-2020/Spec_UT/commit/b270de551c6a02cf207e3691e03e43214ab081e4)
        - Событие ТЧ "Товары"  Поля "Номенклатура"
            - `ПриИзменениИПосле`  
            - вызываем Серверную Функцию `РассчитатьНижнийПорогРентабельностиДляСтрокиТЧТовары`
                - Аргументы (Поля Текущей Строки ТЧ "Товары")
                    - Номенклатура;
                    - Характеристика
    - Создаем Серверную Процедуру [`РассчитатьНижнийПорогРентабельностиДляТЧТовары`](https://github.com/alex-dev-2020/Spec_UT/commit/fac5dc898a67a39240ed925baa033c735daac60b) 
        -  ТЧ Параетром  отдаем в Запрос
        - Соединиемся  с вирт.  Табл `ЦеныНоменклатуры` Срез Последних 
            - ВНУТРЕНЕЕ Соединение, Поля :
                - Номенклатура
                - Характеристика 
        - в Цикле Обходим выборку Рез-та Запроса
        - Метод "Найти строки" (Для ТЧ Товары)
            - Структура Отбора:
                - где ищем: ТЧ Товары, (колонка): "Номер Строки"
                - что ищем: Номер строки из Выборки (Рез-т Запроса)
            - в найденную Строку ТЧ (первый Эл-т результата Поиска) в колонку "Нижний порог рентабельности" пишем Цену из Выборки (Рез-т Запроса)
    - Вызов созданной Процедуры :
        - Основная Конфигурация
            - Модуль Формы Док. "Заказ Клиента"
                - Процедура `ОбработкаВыбораПодборНаСервере`→ добавляем в Расширение `&После` 
                    - отсюда  вызываем `РассчитатьНижнийПорогРентабельностиДляТЧТовары()`
                        - пересчет по ТЧ будет выполняться после завершения Подбора Товаров по кнопке Формы "Подбор"
                - Процедура `ПриСозданииНаСервере` → добавляем в Расширение `&После` 
                    - пересчет по ТЧ при создании Формы 
                - Процедура `ДатаПриИзменении` → добавляем в Расширение `&После` 
                    - пересчет по ТЧ при изменении Даты Документа
                - Процедура `ПослеЗаписиНаСервере` → добавляем в Расширение `&После`
                    - пересчет по ТЧ после записи на Сервере
    - Итоговый [код](https://github.com/alex-dev-2020/Spec_UT/commit/9c32615e54d387ef1ff5b2b800f042746b3faa4f)  
- Реализация Запрета проведения Документа
    - Основная Конфигурация Модуль Объекта  Док "Заказ Клиента"
        -  Процедура `ОбработкаПроведения` → добавляем в Расширение `&После`
            - формируем  выборку по ТЧ Документа по условию, что цена в Документе ниже чем в РС по  Виду "Нижний порог рентабельности"
        - если Выборка НЕ пустая обходим в Цикле:
            - Формируем сообщщение с указанием:
                - Номер Строки;
                - Наименования Номенклатуры.   
    - Роли в Расширении:
        - Добавляем  Роль: `Экз_ПроверкаНижнегоПорогаРентабельности`
            - Док "Заказ Клиента"
                - добавляем Права
                    - Редактирование
                    - Добавление
                    - Проведение
                    - Отмена проведения 
        - Заимствуем из Основной Конфигурации:
           - `Полные права`
           - `ДобавлениеИзменениеЗаказовКлиентов`  
    - Расширение  [Модуль Объекта](https://github.com/alex-dev-2020/Spec_UT/commit/99ffea46cba481738142d8fb4b54f8b3a0761aa6)  Док "Заказ Клиента"
        - проверяем наличе Роли у Текущкего аавторизованного Пользователя
            - Фунцкия `ПроверитьНаличиеРоли()`
        - берем часть кода из Функции `ЕстьРоль()` [Общего Модуля `УправлениеДоступом`](https://github.com/alex-dev-2020/Spec_UT/commit/8ba791f1611d43e8a757c9fbe6c8e614e92f545c)
    - вызываем `ПроверитьНаличиеРоли()` из Обработки проведения

         ```
        НетПроверки = ПроверитьНаличиеРоли();

	    Если НетПроверки Тогда 
		    Возврат;
	    КонецЕсли;

         ```
   ###### Тестирование
    - Приложение


